# Яндекс КИТ 2014.
## Регистрационные задания. Задание #3.

### Описание задания
Задание можно выполнить частично. Подробно объясните все шаги, которые вам удастся сделать.

1. Установите на компьютер VirtualBox https://yadi.sk/d/md2mI-iBbCzBr. Импортируйте архив с конфигурацией стенда из нескольких виртуальных машин. На этих машинах установлена операционная система Ubuntu 14.04. На каждой есть запасные диски, которые сейчас не используются. На каждой установлен Яндекс.Танк и настроен DNS.
2. Установите LAMP и WordPress, разверните резервную копию базы данных.
3. Измерьте производительность приложения с помощью Яндекс.Танка.
4. Повысьте надёжность решения:
    * сделайте его устойчивым к выходу из строя (отключению) любого из жёстких дисков;
    * настройте работу LAMP и WordPress на двух серверах с репликацией данных;
    * обеспечьте сохранение работоспособности при внезапном выключении любого из серверов.
5. Повторно измерьте производительность с помощью Яндекс.Танка.
6. Если это возможно, улучшите производительность полученного решения.
7. Сделайте экспорт конфигурации VirtualBox со всеми машинами стенда, загрузите их на Яндекс.Диск и пришлите ссылку и пояснения своих действий.

### Решение
1. Запустите yakit-z01, зайдите под учетной записью toor и выполните команды
    ````
    sudo su
    apt-get update
    apt-get install -y curl
    source <(curl -s https://raw.githubusercontent.com/KrylCW/YaKit/master/2014/exam00/task03/step01.sh)
    poweroff
    ```
2. Подключите к yakit-z01 LiveCD-образ Debian/Ubuntu, загрузите yakit-z01 в LiveCD-среду и выполните команды
    ```
    sudo su
    source <(curl -s https://raw.githubusercontent.com/KrylCW/YaKit/master/2014/exam00/task03/step02.sh)
    reboot
    ```
3. На yakit-z01 выполните команды
    ```
    sudo su
    source <(curl -s https://raw.githubusercontent.com/KrylCW/YaKit/master/2014/exam00/task03/step03.sh)
    ```
4. Зайдите по http на адрес yakit-z01 и завершите установку Wordpress заполнив поля формы
5. Измените количество RAM yakit-z03 на 768 МБ, загрузите yakit-z03 и выполните команды
    ```
    sudo su
    apt-get update
    apt-get install curl
    source <(curl -s https://raw.githubusercontent.com/KrylCW/YaKit/master/2014/exam00/task03/step05.sh)
    ```
6. На yakit-z01 выполните команды
    ```
    sudo su
    source <(curl -s https://raw.githubusercontent.com/KrylCW/YaKit/master/2014/exam00/task03/step06.sh)
    ```
7. На yakit-z03 выполните команду
    ```
    yandex-tank
    ```
8. На yakit-z01 выполните команды
    ```
    sudo su
    source <(curl -s https://raw.githubusercontent.com/KrylCW/YaKit/master/2014/exam00/task03/step08.sh)
    ```
9. Повторите шаги 1-3, 6, 8 на yakit-z02
10. На yakit-z03 выполните команды
    ```
    sudo su
    source <(curl -s https://raw.githubusercontent.com/KrylCW/YaKit/master/2014/exam00/task03/step10.sh)
    ```
11. По адресу yakit-z03 по HTTP будет доступен список отчетов yandex-tank'а 

### Описание действий по шагам
1. На данном шаге я создаю 2 raid-массива (для boot-партиции и для LVM-группы), переношу данные с boot-партиции на raid-массив, обеспечиваю возможность загрузиться после переноса данных LVM-группы
2. Переношу данные с root-партиции старой LVM-группы на новую, дополнительно делаю проверку партиций (на root-партиции перманентно находятся 2 ошибки неиследованного происхождения)
3. Обеспечиваю возможность загрузиться с любого из двух дисков, устанавливаю Wordpress и настраиваю под него apache2
4. Привожу Wordpress в рабочее состояние
5. Запускаю Яндекс.Танка для тестирования конфигурации по умолчанию
6. Устанавливаю memcached и более тонко настраиваю MySQL под нужды Wordpress
7. Повторно тестирую Яндекс.Танком обновленную конфигурации
8. Настраиваю memcached на работу с двумя серверами, подготавливаю MySQL для работы в режиме Master-Master, устанавливаю Nginx в качестве балансировщика и Linux-HA для обеспечения доступности серверов
9. Настраиваю yakit-z02 аналогично yakit-z01
10. Заканчиваю настройку MySQL репликации, провожу тестирование полученной конфигурации и переношу отчеты Яндекс.Танка в доступное место
11. Получаю доступ к отчетам Яндекс.Танка

### Известные "особенности" решения
* Обнаружил неработоспособный swap из коробки
* Обнаружил несоответствующие действительности записи в DNS для зоны .kit на части серверов (например, на yakit-z01 трансляция yakit-z01.kit <-> 10.0.2.15)
* Не обнаружил резервной копии БД о которой говорится в задании
* Без проверки партиций на втором шаге, система не загружается
* Четвертый шаг можно было бы автоматизировать с помощью восстановления заранее подготовленной БД
* Репликация типа Master-Master на MySQL имеет подводные камни, без дополнительного исследования пригодности подобной репликации для Wordpress в production такое решение пускать нельзя
* Нужно точнее определить настройки влияющие на память, чтобы избегать появления ошибок типа Out Of Memory
* Во время выключения одного из серверов возможно появление ошибки подключения к серверу СУБД (должно правиться порядком загрузки/выключения сервисов)
* После отключения жесткого диска ОС не выдает предложения зайти под пользователем в систему (при этом все службы работают), после перезагрузки проблема не проявляется
* При добавлении новой директории в /var/www/wordpress на серверах yakit-z01 или yakit-z02 для продолжения синхронизации директорий на обоих придется выполнить команды (предположительно лечится переходом с incron на Watcher):
    ```
    fullname=`uname -n`; order=`echo ${fullname: -1}`
    find /var/www/wordpress -type d -print0 | xargs -0 -I{} echo "{} IN_CREATE,IN_DELETE,IN_CLOSE_WRITE env HOME=/ unison -batch /var/www/wordpress/ /net/10.0.2."$((order % 2 + 101))"/var/www/wordpress/" > /etc/incron.d/wordpress.conf
    service incron restart
    ```
* Решение носит специфичный характер, работает исключительно в рамках заданных условий, переносу в другую среду не подлежит

### Тестирование отказоустойчивости
- [x] Проверка работоспособности ОС при выключении одного жесткого диска
- [x] Доступ на чтение при одной выключенной машине
  - [x] Доступ на сайт
  - [x] Доступ в административную панель
- [x] Доступ на запись при одной выключенной машине
