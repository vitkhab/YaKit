# Яндекс КИТ 2014.
## Регистрационные задания. Задание #3.

### Описание задания
Задание можно выполнить частично. Подробно объясните все шаги, которые вам удастся сделать.

1. Установите на компьютер VirtualBox https://yadi.sk/d/md2mI-iBbCzBr. Импортируйте архив с конфигурацией стенда из нескольких виртуальных машин. На этих машинах установлена операционная система Ubuntu 14.04. На каждой есть запасные диски, которые сейчас не используются. На каждой установлен Яндекс.Танк и настроен DNS.
2. Установите LAMP и WordPress, разверните резервную копию базы данных.
3. Измерьте производительность приложения с помощью Яндекс.Танка.
4. Повысьте надёжность решения:
    * сделайте его устойчивым к выходу из строя (отключению) любого из жёстких дисков;
    * настройте работу LAMP и WordPress на двух серверах с репликацией данных;
    * обеспечьте сохранение работоспособности при внезапном выключении любого из серверов.
5. Повторно измерьте производительность с помощью Яндекс.Танка.
6. Если это возможно, улучшите производительность полученного решения.
7. Сделайте экспорт конфигурации VirtualBox со всеми машинами стенда, загрузите их на Яндекс.Диск и пришлите ссылку и пояснения своих действий.

### Решение
1. Запустите yakit-z01, зайдите под учетной записью toor и выполните команды

    ```
    sudo su
    apt-get update
    apt-get install -y curl
    source <(curl -s https://raw.githubusercontent.com/KrylCW/YaKit/master/2014/exam00/task03/step01.sh)
    poweroff
    ```
2. Подключите к yakit-z01 LiveCD-образ Debian/Ubuntu, загрузите yakit-z01 в LiveCD-среду и выполните команды

    ```
    sudo su
    source <(curl -s https://raw.githubusercontent.com/KrylCW/YaKit/master/2014/exam00/task03/step02.sh)
    reboot
    ```
3. На yakit-z01 выполните команды

    ```
    sudo su
    source <(curl -s https://raw.githubusercontent.com/KrylCW/YaKit/master/2014/exam00/task03/step03.sh)
    ```
4. Зайдите по http на адрес yakit-z01 и завершите установку Wordpress заполнив поля формы
5. Измените количество RAM yakit-z03 на 768 МБ, загрузите yakit-z03 и выполните команды

    ```
    sudo su
    apt-get update
    apt-get install curl
    source <(curl -s https://raw.githubusercontent.com/KrylCW/YaKit/master/2014/exam00/task03/step05.sh)
    ```
6. На yakit-z01 выполните команды

    ```
    sudo su
    source <(curl -s https://raw.githubusercontent.com/KrylCW/YaKit/master/2014/exam00/task03/step06.sh)
    ```
7. На yakit-z03 выполните команду

    ```
    yandex-tank
    ```
8. На yakit-z01 выполните команды

    ```
    sudo su
    source <(curl -s https://raw.githubusercontent.com/KrylCW/YaKit/master/2014/exam00/task03/step08.sh)
    ```
9. Повторите шаги 1-3, 6, 8 на yakit-z02
10. На yakit-z03 выполните команды

    ```
    sudo su
    source <(curl -s https://raw.githubusercontent.com/KrylCW/YaKit/master/2014/exam00/task03/step10.sh)
    ```
11. По адресу yakit-z03 по HTTP будет доступен список отчетов yandex-tank'а 

### Описание действий по шагам
1. На данном шаге я создаю 2 raid-массива (для boot-партиции и для LVM-группы), переношу данные с boot-партиции на raid-массив, обеспечиваю возможность загрузиться после переноса данных LVM-группы
2. Переношу данные с root-партиции старой LVM-группы на новую, дополнительно делаю проверку партиций (на root-партиции каждый раз при первом выполнении данного шага находятся 2 ошибки неиследованного происхождения)
3. Обеспечиваю возможность загрузиться с любого из двух дисков, устанавливаю Wordpress и настраиваю под него apache2
4. Привожу Wordpress в рабочее состояние
5. Запускаю Яндекс.Танк для тестирования конфигурации по умолчанию
6. Устанавливаю memcached и более тонко настраиваю MySQL под нужды Wordpress
7. Повторно тестирую Яндекс.Танком обновленную конфигурации
8. Настраиваю memcached на работу с двумя серверами, настраиваю двустороннюю синхронизацию рабочих каталогов Wordpress, подготавливаю MySQL для работы в режиме Master-Master, устанавливаю Nginx в качестве балансировщика и Linux-HA для обеспечения доступности серверов
9. Настраиваю yakit-z02 аналогично yakit-z01
10. Заканчиваю настройку MySQL репликации, провожу тестирование полученной конфигурации и переношу отчеты Яндекс.Танка в доступное по HTTP место
11. Получаю доступ к отчетам Яндекс.Танка

### Интерпретация отчетов Яндекс.Танка
Оптимизация и балансировка позволили немного сгладить кривую "количества обработанных запросов", но вполне возможно что данные показания не выходят за рамки погрешности измерений.

Также в результате тестирования выяснилось, что проделанная оптимизация и балансиовка не улучшают производительность сервиса. Похоже, что проделанная оптимизация не приносит большой выгоды и можно обойтись без нее. А балансировка не помогает из-за ограничений по производительности host-системы на которой работают виртуальные машины

### Тестирование отказоустойчивости
- [x] Проверка работоспособности ОС при выключении одного жесткого диска
- [x] Доступ на чтение при одной выключенной машине
- [x] Создание поста при одной выключенной машине
- [x] Запись файла в директорию /var/www/wordpress при выключенном одном сервере

### Известные "особенности" решения
* Обнаружил неработоспособный swap из коробки, исправлять не стал.
* Обнаружил несоответствующие действительности записи в /etc/hosts для зоны .kit на части серверов (например, на yakit-z01 трансляция yakit-z01.kit <-> 10.0.2.15).
* Не обнаружил резервной копии БД о которой говорится в задании.
* Без проверки партиций на втором шаге, система не загружается.
* После отключения жесткого диска ОС не выдает предложения зайти под пользователем в систему (при этом все службы запускаются и работают), после перезагрузки проблема не проявляется.
* Четвертый шаг можно было бы автоматизировать с помощью восстановления заранее подготовленной БД.
* Во время выключения одного из серверов возможно появление ошибки подключения к серверу СУБД (должно правиться порядком загрузки/выключения сервисов).
* При текущих настройках nginx, а именно равномерном распределении запросов, не получается войти в административную панель, причина в том, что содержимое регистрационной формы отправляется на один сервер, а запрос на переход в административную панель на другой.
* Предыдущая "особенность" решается добавлением в настройки nginx в директиву "http" -> "upstream wordpress" параметра "ip_hash", это позволяет распределять пользовательские сессии по серверам, минус в менее равномерном распределении запросов.
* Репликация типа Master-Master на MySQL имеет подводные камни, без дополнительного исследования пригодности подобной репликации для Wordpress в production такое решение пускать нельзя.
* При добавлении новой директории в /var/www/wordpress на серверах yakit-z01 или yakit-z02 для продолжения синхронизации директорий на обоих серверах придется выполнить команды (предположительно лечится переходом с incron на Watcher):

    ```
    fullname=`uname -n`; order=`echo ${fullname: -1}`
    find /var/www/wordpress -type d -print0 | xargs -0 -I{} echo "{} IN_CREATE,IN_DELETE,IN_CLOSE_WRITE env HOME=/ unison -batch /var/www/wordpress/ /net/10.0.2."$((order % 2 + 101))"/var/www/wordpress/" > /etc/incron.d/wordpress.conf
    service incron restart
    ```
* Решение носит сильно специфичный характер, работает исключительно в рамках заданных условий, переносу в другую среду не подлежит.

### ToDo (в порядке приоритета)
1. Починить возможность входа на сервис
2. Проверить репликацию MySQL типа Master-Master на устойчивость
3. Поменять порядок загрузки/выгрузки демонов
4. Настроить рекурсивную репликацию рабочей директории Wordpress
5. Починить swap
6. Исследовать возможности ускорения полученного сервиса
7. Выяснить причину отсутствия возможности авторизироваться после удаления одного из дисков
8. Выяснить причину возникновения ошибок файловой системы на втором шаге
9. Актуализировать записи /etc/hosts 